# Деплой скрипт для trade_bot

## Описание

Скрипт `deploy.sh` автоматизирует процесс деплоя бота на сервер:
1. Загружает файлы проекта на сервер через `rsync`
2. Останавливает старый Docker контейнер (если запущен)
3. Собирает и запускает новый Docker контейнер

## Настройка

Перед использованием откройте `deploy.sh` и укажите параметры сервера:

```bash
# Адрес сервера (IP или домен)
SERVER_HOST="your-server.com"

# Пользователь для SSH подключения
SERVER_USER="root"

# Путь к папке на сервере, куда загружать проект
SERVER_PATH="/opt/trade_bot"

# Порт SSH (по умолчанию 22)
SSH_PORT="22"
```

## Требования

### На локальной машине:
- `rsync` (обычно уже установлен на macOS/Linux)
- `ssh` клиент
- SSH ключ должен быть добавлен на сервер

### На сервере:
- Docker и Docker Compose установлены
- SSH доступ настроен
- Пользователь имеет права на выполнение Docker команд

## Использование

### Полный деплой (по умолчанию):
```bash
./deploy.sh
# или
./deploy.sh deploy
```

### Просмотр логов:
```bash
./deploy.sh logs
```

### Проверка статуса:
```bash
./deploy.sh status
```

### Остановка контейнера:
```bash
./deploy.sh stop
```

### Перезапуск контейнера:
```bash
./deploy.sh restart
```

## Что загружается на сервер

Скрипт загружает все необходимые файлы, исключая:
- `.git/` - папка git
- `__pycache__/` - кэш Python
- `*.pyc` - скомпилированные файлы
- `.pytest_cache/` - кэш pytest
- `venv/` - виртуальное окружение
- `.env` - файл с переменными окружения (должен быть на сервере)
- `bot/users.db` - база данных (сохраняется на сервере)
- `develop/` - папка для разработки
- `tests/` - тесты
- `pytest.ini` - конфигурация pytest

## Важные замечания

1. **Файл .env**: Убедитесь, что файл `.env` с переменными окружения уже находится на сервере в папке `$SERVER_PATH`. Он не загружается скриптом для безопасности.

2. **База данных**: Файл `bot/users.db` не загружается, чтобы не перезаписать данные на сервере. База данных сохраняется через volume в docker-compose.yml.

3. **SSH ключ**: Для автоматического подключения добавьте ваш SSH ключ на сервер:
   ```bash
   ssh-copy-id -p $SSH_PORT $SERVER_USER@$SERVER_HOST
   ```

4. **Права доступа**: Убедитесь, что пользователь на сервере имеет права на выполнение Docker команд без sudo (или добавьте пользователя в группу docker).

## Первый деплой

При первом деплое на сервере:

1. Создайте папку для проекта:
   ```bash
   ssh $SERVER_USER@$SERVER_HOST "mkdir -p $SERVER_PATH"
   ```

2. Скопируйте файл `.env` на сервер:
   ```bash
   scp -P $SSH_PORT .env $SERVER_USER@$SERVER_HOST:$SERVER_PATH/.env
   ```

3. Запустите деплой:
   ```bash
   ./deploy.sh
   ```

## Мониторинг

После деплоя можно мониторить работу бота:

```bash
# Просмотр логов в реальном времени
ssh -p $SSH_PORT $SERVER_USER@$SERVER_HOST "cd $SERVER_PATH && docker-compose logs -f bot"

# Проверка статуса
ssh -p $SSH_PORT $SERVER_USER@$SERVER_HOST "cd $SERVER_PATH && docker-compose ps"

# Статистика использования ресурсов
ssh -p $SSH_PORT $SERVER_USER@$SERVER_HOST "docker stats opinion_trade_bot"
```

